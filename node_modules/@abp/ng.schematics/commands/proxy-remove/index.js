"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const schematics_1 = require("@angular-devkit/schematics");
const utils_1 = require("../../utils");
function default_1(schema) {
    const params = utils_1.removeDefaultPlaceholders(schema);
    const moduleName = params.module || 'app';
    return async (host, _context) => {
        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
        const target = await utils_1.resolveProject(host, params.target);
        const targetPath = utils_1.buildDefaultPath(target.definition);
        const readProxyConfig = utils_1.createProxyConfigReader(targetPath);
        const { generated } = readProxyConfig(host);
        const index = generated.findIndex(m => m === moduleName);
        if (index < 0)
            return host;
        generated.splice(index, 1);
        const getApiDefinition = utils_1.createApiDefinitionGetter(params);
        const data = Object.assign({ generated }, (await getApiDefinition(host)));
        data.generated = [];
        const clearProxy = utils_1.createProxyClearer(targetPath);
        const saveProxyConfig = utils_1.createProxyConfigSaver(data, targetPath);
        const generateApis = utils_1.createApisGenerator(schema, generated);
        const generateIndex = utils_1.createProxyIndexGenerator(targetPath);
        return schematics_1.chain([
            utils_1.mergeAndAllowDelete(host, clearProxy),
            saveProxyConfig,
            generateApis,
            generateIndex,
        ]);
    };
}
exports.default = default_1;
//# sourceMappingURL=index.js.map