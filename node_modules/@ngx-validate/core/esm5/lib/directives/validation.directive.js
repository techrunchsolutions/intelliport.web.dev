/**
 * @fileoverview added by tsickle
 * Generated from: lib/directives/validation.directive.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { ChangeDetectorRef, ComponentFactoryResolver, ComponentRef, Directive, Injector, Optional, Renderer2, Self, SkipSelf, TemplateRef, ViewContainerRef, } from '@angular/core';
import { FormGroupDirective, NgControl } from '@angular/forms';
import { merge, Subscription } from 'rxjs';
import { filter, map, mapTo, tap } from 'rxjs/operators';
import { AbstractValidationDirective } from '../abstracts';
import { generateValidationError } from '../utils';
import { ValidationContainerDirective } from './validation-container.directive';
import { ValidationGroupDirective } from './validation-group.directive';
import { ValidationStyleDirective } from './validation-style.directive';
import { ValidationTargetDirective } from './validation-target.directive';
var ValidationDirective = /** @class */ (function (_super) {
    tslib_1.__extends(ValidationDirective, _super);
    function ValidationDirective(injector, cdRef, cfRes, control, renderer, vcRef, parentRef, markRef, targetRef, containerRef, formGroupDirective) {
        var _this = _super.call(this, injector) || this;
        _this.injector = injector;
        _this.cdRef = cdRef;
        _this.cfRes = cfRes;
        _this.control = control;
        _this.renderer = renderer;
        _this.vcRef = vcRef;
        _this.parentRef = parentRef;
        _this.markRef = markRef;
        _this.targetRef = targetRef;
        _this.containerRef = containerRef;
        _this.formGroupDirective = formGroupDirective;
        _this.isSubmitted = false;
        _this.subscriptions = new Subscription();
        return _this;
    }
    Object.defineProperty(ValidationDirective.prototype, "validation$", {
        get: /**
         * @return {?}
         */
        function () {
            return merge(this.parent.getStream('status').pipe(mapTo(null)), this.parent.getStream('value').pipe(mapTo(null)), this.parent.getStream('submit'));
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @private
     * @param {?} errors
     * @return {?}
     */
    ValidationDirective.prototype.buildErrors = /**
     * @private
     * @param {?} errors
     * @return {?}
     */
    function (errors) {
        var _this = this;
        return Object.keys(errors || {}).map((/**
         * @param {?} key
         * @return {?}
         */
        function (key) {
            return generateValidationError(key, errors[key], _this.blueprints[key]);
        }));
    };
    /**
     * @private
     * @return {?}
     */
    ValidationDirective.prototype.insertErrorClasses = /**
     * @private
     * @return {?}
     */
    function () {
        this.renderer.addClass(this.markElement, this.invalidClasses);
    };
    /**
     * @private
     * @this {?}
     * @param {?} errors
     * @return {?}
     */
    ValidationDirective.prototype.insertErrors = /**
     * @private
     * @this {?}
     * @param {?} errors
     * @return {?}
     */
    function (errors) {
        /** @type {?} */
        var template = this.errorTemplate;
        /** @type {?} */
        var targetRef = this.containerRef ? this.containerRef.targetRef : this.targetRef;
        /** @type {?} */
        var vcRef = targetRef ? targetRef.vcRef : this.vcRef;
        this.errorRef =
            template instanceof TemplateRef
                ? vcRef.createEmbeddedView(template, { $implicit: errors }, vcRef.length)
                : vcRef.createComponent(this.cfRes.resolveComponentFactory(template), vcRef.length, this.injector);
        if (this.errorRef instanceof ComponentRef && this.errorRef.instance)
            ((/** @type {?} */ (this.errorRef))).instance.validationErrors = errors;
    };
    /**
     * @private
     * @return {?}
     */
    ValidationDirective.prototype.removeErrorClasses = /**
     * @private
     * @return {?}
     */
    function () {
        this.renderer.removeClass(this.markElement, this.invalidClasses);
    };
    /**
     * @private
     * @return {?}
     */
    ValidationDirective.prototype.removeErrors = /**
     * @private
     * @return {?}
     */
    function () {
        if (this.errorRef) {
            this.errorRef.destroy();
            this.errorRef = null;
        }
    };
    /**
     * @private
     * @return {?}
     */
    ValidationDirective.prototype.setMarkElement = /**
     * @private
     * @return {?}
     */
    function () {
        this.markElement =
            (this.markRef
                ? this.markRef.elRef.nativeElement
                : this.targetSelector
                    ? this.elRef.nativeElement.closest(this.targetSelector)
                    : null) || this.elRef.nativeElement;
    };
    /**
     * @private
     * @param {?} errors
     * @return {?}
     */
    ValidationDirective.prototype.shouldValidate = /**
     * @private
     * @param {?} errors
     * @return {?}
     */
    function (errors) {
        return errors.length && this.control.dirty && (!this.validateOnSubmit || this.isSubmitted);
    };
    /**
     * @private
     * @return {?}
     */
    ValidationDirective.prototype.subscribeToValidation = /**
     * @private
     * @return {?}
     */
    function () {
        var _this = this;
        /** @type {?} */
        var cached;
        this.subscriptions.add(this.validation$
            .pipe(filter((/**
         * @return {?}
         */
        function () { return !_this.skipValidation; })), tap((/**
         * @param {?} form
         * @return {?}
         */
        function (form) {
            if (form && _this.formGroupDirective.submitted) {
                _this.control.control.markAsDirty();
                _this.isSubmitted = true;
            }
        })), map((/**
         * @return {?}
         */
        function () {
            return _this.mapErrorsFn(_this.buildErrors(_this.control.errors), _this.buildErrors((_this.parentRef.group || ((/** @type {?} */ ({})))).errors), _this.control);
        })))
            .subscribe((/**
         * @param {?} errors
         * @return {?}
         */
        function (errors) {
            if (cached === JSON.stringify(errors))
                return;
            _this.removeErrors();
            if (_this.shouldValidate(errors)) {
                _this.insertErrors(errors);
                if (!cached)
                    _this.insertErrorClasses();
                cached = JSON.stringify(errors);
            }
            else {
                _this.removeErrorClasses();
                cached = '';
            }
            _this.cdRef.markForCheck();
        })));
    };
    /**
     * @return {?}
     */
    ValidationDirective.prototype.ngAfterViewInit = /**
     * @return {?}
     */
    function () {
        this.setMarkElement();
        this.subscribeToValidation();
    };
    /**
     * @return {?}
     */
    ValidationDirective.prototype.ngOnDestroy = /**
     * @return {?}
     */
    function () {
        this.subscriptions.unsubscribe();
    };
    ValidationDirective.decorators = [
        { type: Directive, args: [{
                    /* tslint:disable-next-line */
                    selector: '[formControl],[formControlName]',
                    exportAs: 'validationDirective',
                },] }
    ];
    /** @nocollapse */
    ValidationDirective.ctorParameters = function () { return [
        { type: Injector },
        { type: ChangeDetectorRef },
        { type: ComponentFactoryResolver },
        { type: NgControl, decorators: [{ type: Self }] },
        { type: Renderer2 },
        { type: ViewContainerRef },
        { type: ValidationGroupDirective, decorators: [{ type: SkipSelf }] },
        { type: ValidationStyleDirective, decorators: [{ type: Optional }, { type: SkipSelf }] },
        { type: ValidationTargetDirective, decorators: [{ type: Optional }, { type: SkipSelf }] },
        { type: ValidationContainerDirective, decorators: [{ type: Optional }] },
        { type: FormGroupDirective, decorators: [{ type: Optional }] }
    ]; };
    return ValidationDirective;
}(AbstractValidationDirective));
export { ValidationDirective };
if (false) {
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.errorRef;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.markElement;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.isSubmitted;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.subscriptions;
    /** @type {?} */
    ValidationDirective.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.cdRef;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.cfRes;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.control;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.renderer;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.vcRef;
    /** @type {?} */
    ValidationDirective.prototype.parentRef;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.markRef;
    /** @type {?} */
    ValidationDirective.prototype.targetRef;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.containerRef;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.formGroupDirective;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmFsaWRhdGlvbi5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Abmd4LXZhbGlkYXRlL2NvcmUvIiwic291cmNlcyI6WyJsaWIvZGlyZWN0aXZlcy92YWxpZGF0aW9uLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxPQUFPLEVBRUwsaUJBQWlCLEVBQ2pCLHdCQUF3QixFQUN4QixZQUFZLEVBQ1osU0FBUyxFQUVULFFBQVEsRUFFUixRQUFRLEVBQ1IsU0FBUyxFQUNULElBQUksRUFDSixRQUFRLEVBQ1IsV0FBVyxFQUNYLGdCQUFnQixHQUNqQixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQWEsa0JBQWtCLEVBQUUsU0FBUyxFQUFvQixNQUFNLGdCQUFnQixDQUFDO0FBQzVGLE9BQU8sRUFBRSxLQUFLLEVBQWMsWUFBWSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3ZELE9BQU8sRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6RCxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFHM0QsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ25ELE9BQU8sRUFBRSw0QkFBNEIsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQ2hGLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQ3hFLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQ3hFLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBRTFFO0lBS3lDLCtDQUEyQjtJQWdCbEUsNkJBQ1MsUUFBa0IsRUFDakIsS0FBd0IsRUFDeEIsS0FBK0IsRUFDdkIsT0FBa0IsRUFDMUIsUUFBbUIsRUFDbkIsS0FBdUIsRUFDWixTQUFtQyxFQUN0QixPQUFpQyxFQUNsQyxTQUFvQyxFQUMv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OztJQUFmO1FBQ0UsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO0lBQy9CLENBQUM7Ozs7SUFFRCx5Q0FBVzs7O0lBQVg7UUFDRSxJQUFJLENBQUMsYUFBYSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ25DLENBQUM7O2dCQXhJRixTQUFTLFNBQUM7O29CQUVULFFBQVEsRUFBRSxpQ0FBaUM7b0JBQzNDLFFBQVEsRUFBRSxxQkFBcUI7aUJBQ2hDOzs7O2dCQXpCQyxRQUFRO2dCQUxSLGlCQUFpQjtnQkFDakIsd0JBQXdCO2dCQWFjLFNBQVMsdUJBcUM1QyxJQUFJO2dCQTNDUCxTQUFTO2dCQUlULGdCQUFnQjtnQkFVVCx3QkFBd0IsdUJBZ0M1QixRQUFRO2dCQS9CSix3QkFBd0IsdUJBZ0M1QixRQUFRLFlBQUksUUFBUTtnQkEvQmhCLHlCQUF5Qix1QkFnQzdCLFFBQVEsWUFBSSxRQUFRO2dCQW5DaEIsNEJBQTRCLHVCQW9DaEMsUUFBUTtnQkEzQ08sa0JBQWtCLHVCQTRDakMsUUFBUTs7SUF5R2IsMEJBQUM7Q0FBQSxBQXpJRCxDQUt5QywyQkFBMkIsR0FvSW5FO1NBcElZLG1CQUFtQjs7Ozs7O0lBRTlCLHVDQUFnRjs7Ozs7SUFDaEYsMENBQWlDOzs7OztJQUNqQywwQ0FBNEI7Ozs7O0lBVTVCLDRDQUEyQzs7SUFHekMsdUNBQXlCOzs7OztJQUN6QixvQ0FBZ0M7Ozs7O0lBQ2hDLG9DQUF1Qzs7Ozs7SUFDdkMsc0NBQWtDOzs7OztJQUNsQyx1Q0FBMkI7Ozs7O0lBQzNCLG9DQUErQjs7SUFDL0Isd0NBQXNEOzs7OztJQUN0RCxzQ0FBaUU7O0lBQ2pFLHdDQUFtRTs7Ozs7SUFDbkUsMkNBQThEOzs7OztJQUM5RCxpREFBMEQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBZnRlclZpZXdJbml0LFxuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICBDb21wb25lbnRSZWYsXG4gIERpcmVjdGl2ZSxcbiAgRW1iZWRkZWRWaWV3UmVmLFxuICBJbmplY3RvcixcbiAgT25EZXN0cm95LFxuICBPcHRpb25hbCxcbiAgUmVuZGVyZXIyLFxuICBTZWxmLFxuICBTa2lwU2VsZixcbiAgVGVtcGxhdGVSZWYsXG4gIFZpZXdDb250YWluZXJSZWYsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRm9ybUdyb3VwLCBGb3JtR3JvdXBEaXJlY3RpdmUsIE5nQ29udHJvbCwgVmFsaWRhdGlvbkVycm9ycyB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IG1lcmdlLCBPYnNlcnZhYmxlLCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGZpbHRlciwgbWFwLCBtYXBUbywgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQWJzdHJhY3RWYWxpZGF0aW9uRGlyZWN0aXZlIH0gZnJvbSAnLi4vYWJzdHJhY3RzJztcbmltcG9ydCB7IFZhbGlkYXRpb25FcnJvckNvbXBvbmVudCB9IGZyb20gJy4uL2NvbXBvbmVudHMnO1xuaW1wb3J0IHsgVmFsaWRhdGlvbiB9IGZyb20gJy4uL21vZGVscyc7XG5pbXBvcnQgeyBnZW5lcmF0ZVZhbGlkYXRpb25FcnJvciB9IGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB7IFZhbGlkYXRpb25Db250YWluZXJEaXJlY3RpdmUgfSBmcm9tICcuL3ZhbGlkYXRpb24tY29udGFpbmVyLmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBWYWxpZGF0aW9uR3JvdXBEaXJlY3RpdmUgfSBmcm9tICcuL3ZhbGlkYXRpb24tZ3JvdXAuZGlyZWN0aXZlJztcbmltcG9ydCB7IFZhbGlkYXRpb25TdHlsZURpcmVjdGl2ZSB9IGZyb20gJy4vdmFsaWRhdGlvbi1zdHlsZS5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgVmFsaWRhdGlvblRhcmdldERpcmVjdGl2ZSB9IGZyb20gJy4vdmFsaWRhdGlvbi10YXJnZXQuZGlyZWN0aXZlJztcblxuQERpcmVjdGl2ZSh7XG4gIC8qIHRzbGludDpkaXNhYmxlLW5leHQtbGluZSAqL1xuICBzZWxlY3RvcjogJ1tmb3JtQ29udHJvbF0sW2Zvcm1Db250cm9sTmFtZV0nLFxuICBleHBvcnRBczogJ3ZhbGlkYXRpb25EaXJlY3RpdmUnLFxufSlcbmV4cG9ydCBjbGFzcyBWYWxpZGF0aW9uRGlyZWN0aXZlIGV4dGVuZHMgQWJzdHJhY3RWYWxpZGF0aW9uRGlyZWN0aXZlXG4gIGltcGxlbWVudHMgQWZ0ZXJWaWV3SW5pdCwgT25EZXN0cm95IHtcbiAgcHJpdmF0ZSBlcnJvclJlZjogQ29tcG9uZW50UmVmPFZhbGlkYXRpb25FcnJvckNvbXBvbmVudD4gfCBFbWJlZGRlZFZpZXdSZWY8YW55PjtcbiAgcHJpdmF0ZSBtYXJrRWxlbWVudDogSFRNTEVsZW1lbnQ7XG4gIHByaXZhdGUgaXNTdWJtaXR0ZWQgPSBmYWxzZTtcblxuICBnZXQgdmFsaWRhdGlvbiQoKTogT2JzZXJ2YWJsZTxGb3JtR3JvdXA+IHtcbiAgICByZXR1cm4gbWVyZ2UoXG4gICAgICB0aGlzLnBhcmVudC5nZXRTdHJlYW0oJ3N0YXR1cycpLnBpcGUobWFwVG8obnVsbCkpLFxuICAgICAgdGhpcy5wYXJlbnQuZ2V0U3RyZWFtKCd2YWx1ZScpLnBpcGUobWFwVG8obnVsbCkpLFxuICAgICAgdGhpcy5wYXJlbnQuZ2V0U3RyZWFtKCdzdWJtaXQnKSxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBzdWJzY3JpcHRpb25zID0gbmV3IFN1YnNjcmlwdGlvbigpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBpbmplY3RvcjogSW5qZWN0b3IsXG4gICAgcHJpdmF0ZSBjZFJlZjogQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gICAgcHJpdmF0ZSBjZlJlczogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICAgIEBTZWxmKCkgcHJpdmF0ZSBjb250cm9sOiBOZ0NvbnRyb2wsXG4gICAgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyLFxuICAgIHByaXZhdGUgdmNSZWY6IFZpZXdDb250YWluZXJSZWYsXG4gICAgQFNraXBTZWxmKCkgcHVibGljIHBhcmVudFJlZjogVmFsaWRhdGlvbkdyb3VwRGlyZWN0aXZlLFxuICAgIEBPcHRpb25hbCgpIEBTa2lwU2VsZigpIHByaXZhdGUgbWFya1JlZjogVmFsaWRhdGlvblN0eWxlRGlyZWN0aXZlLFxuICAgIEBPcHRpb25hbCgpIEBTa2lwU2VsZigpIHB1YmxpYyB0YXJnZXRSZWY6IFZhbGlkYXRpb25UYXJnZXREaXJlY3RpdmUsXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBjb250YWluZXJSZWY6IFZhbGlkYXRpb25Db250YWluZXJEaXJlY3RpdmUsXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBmb3JtR3JvdXBEaXJlY3RpdmU6IEZvcm1Hcm91cERpcmVjdGl2ZSxcbiAgKSB7XG4gICAgc3VwZXIoaW5qZWN0b3IpO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZEVycm9ycyhlcnJvcnM6IFZhbGlkYXRpb25FcnJvcnMpOiBWYWxpZGF0aW9uLkVycm9yW10ge1xuICAgIHJldHVybiBPYmplY3Qua2V5cyhlcnJvcnMgfHwge30pLm1hcChrZXkgPT5cbiAgICAgIGdlbmVyYXRlVmFsaWRhdGlvbkVycm9yKGtleSwgZXJyb3JzW2tleV0sIHRoaXMuYmx1ZXByaW50c1trZXldKSxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBpbnNlcnRFcnJvckNsYXNzZXMoKSB7XG4gICAgdGhpcy5yZW5kZXJlci5hZGRDbGFzcyh0aGlzLm1hcmtFbGVtZW50LCB0aGlzLmludmFsaWRDbGFzc2VzKTtcbiAgfVxuXG4gIHByaXZhdGUgaW5zZXJ0RXJyb3JzKHRoaXM6IFZhbGlkYXRpb25EaXJlY3RpdmUsIGVycm9yczogVmFsaWRhdGlvbi5FcnJvcltdKTogdm9pZCB7XG4gICAgY29uc3QgdGVtcGxhdGUgPSB0aGlzLmVycm9yVGVtcGxhdGU7XG4gICAgY29uc3QgdGFyZ2V0UmVmID0gdGhpcy5jb250YWluZXJSZWYgPyB0aGlzLmNvbnRhaW5lclJlZi50YXJnZXRSZWYgOiB0aGlzLnRhcmdldFJlZjtcbiAgICBjb25zdCB2Y1JlZiA9IHRhcmdldFJlZiA/IHRhcmdldFJlZi52Y1JlZiA6IHRoaXMudmNSZWY7XG5cbiAgICB0aGlzLmVycm9yUmVmID1cbiAgICAgIHRlbXBsYXRlIGluc3RhbmNlb2YgVGVtcGxhdGVSZWZcbiAgICAgICAgPyB2Y1JlZi5jcmVhdGVFbWJlZGRlZFZpZXcodGVtcGxhdGUsIHsgJGltcGxpY2l0OiBlcnJvcnMgfSwgdmNSZWYubGVuZ3RoKVxuICAgICAgICA6IHZjUmVmLmNyZWF0ZUNvbXBvbmVudChcbiAgICAgICAgICAgIHRoaXMuY2ZSZXMucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkodGVtcGxhdGUpLFxuICAgICAgICAgICAgdmNSZWYubGVuZ3RoLFxuICAgICAgICAgICAgdGhpcy5pbmplY3RvcixcbiAgICAgICAgICApO1xuXG4gICAgaWYgKHRoaXMuZXJyb3JSZWYgaW5zdGFuY2VvZiBDb21wb25lbnRSZWYgJiYgdGhpcy5lcnJvclJlZi5pbnN0YW5jZSlcbiAgICAgICh0aGlzLmVycm9yUmVmIGFzIENvbXBvbmVudFJlZjxhbnk+KS5pbnN0YW5jZS52YWxpZGF0aW9uRXJyb3JzID0gZXJyb3JzO1xuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVFcnJvckNsYXNzZXMoKSB7XG4gICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDbGFzcyh0aGlzLm1hcmtFbGVtZW50LCB0aGlzLmludmFsaWRDbGFzc2VzKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlRXJyb3JzKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmVycm9yUmVmKSB7XG4gICAgICB0aGlzLmVycm9yUmVmLmRlc3Ryb3koKTtcbiAgICAgIHRoaXMuZXJyb3JSZWYgPSBudWxsO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2V0TWFya0VsZW1lbnQoKTogdm9pZCB7XG4gICAgdGhpcy5tYXJrRWxlbWVudCA9XG4gICAgICAodGhpcy5tYXJrUmVmXG4gICAgICAgID8gdGhpcy5tYXJrUmVmLmVsUmVmLm5hdGl2ZUVsZW1lbnRcbiAgICAgICAgOiB0aGlzLnRhcmdldFNlbGVjdG9yXG4gICAgICAgID8gdGhpcy5lbFJlZi5uYXRpdmVFbGVtZW50LmNsb3Nlc3QodGhpcy50YXJnZXRTZWxlY3RvcilcbiAgICAgICAgOiBudWxsKSB8fCB0aGlzLmVsUmVmLm5hdGl2ZUVsZW1lbnQ7XG4gIH1cblxuICBwcml2YXRlIHNob3VsZFZhbGlkYXRlKGVycm9yczogVmFsaWRhdGlvbi5FcnJvcltdKSB7XG4gICAgcmV0dXJuIGVycm9ycy5sZW5ndGggJiYgdGhpcy5jb250cm9sLmRpcnR5ICYmICghdGhpcy52YWxpZGF0ZU9uU3VibWl0IHx8IHRoaXMuaXNTdWJtaXR0ZWQpO1xuICB9XG5cbiAgcHJpdmF0ZSBzdWJzY3JpYmVUb1ZhbGlkYXRpb24oKTogdm9pZCB7XG4gICAgbGV0IGNhY2hlZDogc3RyaW5nO1xuXG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLmFkZChcbiAgICAgIHRoaXMudmFsaWRhdGlvbiRcbiAgICAgICAgLnBpcGUoXG4gICAgICAgICAgZmlsdGVyKCgpID0+ICF0aGlzLnNraXBWYWxpZGF0aW9uKSxcbiAgICAgICAgICB0YXAoZm9ybSA9PiB7XG4gICAgICAgICAgICBpZiAoZm9ybSAmJiB0aGlzLmZvcm1Hcm91cERpcmVjdGl2ZS5zdWJtaXR0ZWQpIHtcbiAgICAgICAgICAgICAgdGhpcy5jb250cm9sLmNvbnRyb2wubWFya0FzRGlydHkoKTtcbiAgICAgICAgICAgICAgdGhpcy5pc1N1Ym1pdHRlZCA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSksXG4gICAgICAgICAgbWFwKCgpID0+XG4gICAgICAgICAgICB0aGlzLm1hcEVycm9yc0ZuKFxuICAgICAgICAgICAgICB0aGlzLmJ1aWxkRXJyb3JzKHRoaXMuY29udHJvbC5lcnJvcnMpLFxuICAgICAgICAgICAgICB0aGlzLmJ1aWxkRXJyb3JzKCh0aGlzLnBhcmVudFJlZi5ncm91cCB8fCAoe30gYXMgRm9ybUdyb3VwKSkuZXJyb3JzKSxcbiAgICAgICAgICAgICAgdGhpcy5jb250cm9sLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICApLFxuICAgICAgICApXG4gICAgICAgIC5zdWJzY3JpYmUoZXJyb3JzID0+IHtcbiAgICAgICAgICBpZiAoY2FjaGVkID09PSBKU09OLnN0cmluZ2lmeShlcnJvcnMpKSByZXR1cm47XG5cbiAgICAgICAgICB0aGlzLnJlbW92ZUVycm9ycygpO1xuXG4gICAgICAgICAgaWYgKHRoaXMuc2hvdWxkVmFsaWRhdGUoZXJyb3JzKSkge1xuICAgICAgICAgICAgdGhpcy5pbnNlcnRFcnJvcnMoZXJyb3JzKTtcbiAgICAgICAgICAgIGlmICghY2FjaGVkKSB0aGlzLmluc2VydEVycm9yQ2xhc3NlcygpO1xuICAgICAgICAgICAgY2FjaGVkID0gSlNPTi5zdHJpbmdpZnkoZXJyb3JzKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5yZW1vdmVFcnJvckNsYXNzZXMoKTtcbiAgICAgICAgICAgIGNhY2hlZCA9ICcnO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHRoaXMuY2RSZWYubWFya0ZvckNoZWNrKCk7XG4gICAgICAgIH0pLFxuICAgICk7XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgdGhpcy5zZXRNYXJrRWxlbWVudCgpO1xuICAgIHRoaXMuc3Vic2NyaWJlVG9WYWxpZGF0aW9uKCk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMudW5zdWJzY3JpYmUoKTtcbiAgfVxufVxuIl19