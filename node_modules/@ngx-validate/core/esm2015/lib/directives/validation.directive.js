/**
 * @fileoverview added by tsickle
 * Generated from: lib/directives/validation.directive.ts
 * @suppress {checkTypes,constantProperty,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { ChangeDetectorRef, ComponentFactoryResolver, ComponentRef, Directive, Injector, Optional, Renderer2, Self, SkipSelf, TemplateRef, ViewContainerRef, } from '@angular/core';
import { FormGroupDirective, NgControl } from '@angular/forms';
import { merge, Subscription } from 'rxjs';
import { filter, map, mapTo, tap } from 'rxjs/operators';
import { AbstractValidationDirective } from '../abstracts';
import { generateValidationError } from '../utils';
import { ValidationContainerDirective } from './validation-container.directive';
import { ValidationGroupDirective } from './validation-group.directive';
import { ValidationStyleDirective } from './validation-style.directive';
import { ValidationTargetDirective } from './validation-target.directive';
export class ValidationDirective extends AbstractValidationDirective {
    /**
     * @param {?} injector
     * @param {?} cdRef
     * @param {?} cfRes
     * @param {?} control
     * @param {?} renderer
     * @param {?} vcRef
     * @param {?} parentRef
     * @param {?} markRef
     * @param {?} targetRef
     * @param {?} containerRef
     * @param {?} formGroupDirective
     */
    constructor(injector, cdRef, cfRes, control, renderer, vcRef, parentRef, markRef, targetRef, containerRef, formGroupDirective) {
        super(injector);
        this.injector = injector;
        this.cdRef = cdRef;
        this.cfRes = cfRes;
        this.control = control;
        this.renderer = renderer;
        this.vcRef = vcRef;
        this.parentRef = parentRef;
        this.markRef = markRef;
        this.targetRef = targetRef;
        this.containerRef = containerRef;
        this.formGroupDirective = formGroupDirective;
        this.isSubmitted = false;
        this.subscriptions = new Subscription();
    }
    /**
     * @return {?}
     */
    get validation$() {
        return merge(this.parent.getStream('status').pipe(mapTo(null)), this.parent.getStream('value').pipe(mapTo(null)), this.parent.getStream('submit'));
    }
    /**
     * @private
     * @param {?} errors
     * @return {?}
     */
    buildErrors(errors) {
        return Object.keys(errors || {}).map((/**
         * @param {?} key
         * @return {?}
         */
        key => generateValidationError(key, errors[key], this.blueprints[key])));
    }
    /**
     * @private
     * @return {?}
     */
    insertErrorClasses() {
        this.renderer.addClass(this.markElement, this.invalidClasses);
    }
    /**
     * @private
     * @this {?}
     * @param {?} errors
     * @return {?}
     */
    insertErrors(errors) {
        /** @type {?} */
        const template = this.errorTemplate;
        /** @type {?} */
        const targetRef = this.containerRef ? this.containerRef.targetRef : this.targetRef;
        /** @type {?} */
        const vcRef = targetRef ? targetRef.vcRef : this.vcRef;
        this.errorRef =
            template instanceof TemplateRef
                ? vcRef.createEmbeddedView(template, { $implicit: errors }, vcRef.length)
                : vcRef.createComponent(this.cfRes.resolveComponentFactory(template), vcRef.length, this.injector);
        if (this.errorRef instanceof ComponentRef && this.errorRef.instance)
            ((/** @type {?} */ (this.errorRef))).instance.validationErrors = errors;
    }
    /**
     * @private
     * @return {?}
     */
    removeErrorClasses() {
        this.renderer.removeClass(this.markElement, this.invalidClasses);
    }
    /**
     * @private
     * @return {?}
     */
    removeErrors() {
        if (this.errorRef) {
            this.errorRef.destroy();
            this.errorRef = null;
        }
    }
    /**
     * @private
     * @return {?}
     */
    setMarkElement() {
        this.markElement =
            (this.markRef
                ? this.markRef.elRef.nativeElement
                : this.targetSelector
                    ? this.elRef.nativeElement.closest(this.targetSelector)
                    : null) || this.elRef.nativeElement;
    }
    /**
     * @private
     * @param {?} errors
     * @return {?}
     */
    shouldValidate(errors) {
        return errors.length && this.control.dirty && (!this.validateOnSubmit || this.isSubmitted);
    }
    /**
     * @private
     * @return {?}
     */
    subscribeToValidation() {
        /** @type {?} */
        let cached;
        this.subscriptions.add(this.validation$
            .pipe(filter((/**
         * @return {?}
         */
        () => !this.skipValidation)), tap((/**
         * @param {?} form
         * @return {?}
         */
        form => {
            if (form && this.formGroupDirective.submitted) {
                this.control.control.markAsDirty();
                this.isSubmitted = true;
            }
        })), map((/**
         * @return {?}
         */
        () => this.mapErrorsFn(this.buildErrors(this.control.errors), this.buildErrors((this.parentRef.group || ((/** @type {?} */ ({})))).errors), this.control))))
            .subscribe((/**
         * @param {?} errors
         * @return {?}
         */
        errors => {
            if (cached === JSON.stringify(errors))
                return;
            this.removeErrors();
            if (this.shouldValidate(errors)) {
                this.insertErrors(errors);
                if (!cached)
                    this.insertErrorClasses();
                cached = JSON.stringify(errors);
            }
            else {
                this.removeErrorClasses();
                cached = '';
            }
            this.cdRef.markForCheck();
        })));
    }
    /**
     * @return {?}
     */
    ngAfterViewInit() {
        this.setMarkElement();
        this.subscribeToValidation();
    }
    /**
     * @return {?}
     */
    ngOnDestroy() {
        this.subscriptions.unsubscribe();
    }
}
ValidationDirective.decorators = [
    { type: Directive, args: [{
                /* tslint:disable-next-line */
                selector: '[formControl],[formControlName]',
                exportAs: 'validationDirective',
            },] }
];
/** @nocollapse */
ValidationDirective.ctorParameters = () => [
    { type: Injector },
    { type: ChangeDetectorRef },
    { type: ComponentFactoryResolver },
    { type: NgControl, decorators: [{ type: Self }] },
    { type: Renderer2 },
    { type: ViewContainerRef },
    { type: ValidationGroupDirective, decorators: [{ type: SkipSelf }] },
    { type: ValidationStyleDirective, decorators: [{ type: Optional }, { type: SkipSelf }] },
    { type: ValidationTargetDirective, decorators: [{ type: Optional }, { type: SkipSelf }] },
    { type: ValidationContainerDirective, decorators: [{ type: Optional }] },
    { type: FormGroupDirective, decorators: [{ type: Optional }] }
];
if (false) {
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.errorRef;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.markElement;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.isSubmitted;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.subscriptions;
    /** @type {?} */
    ValidationDirective.prototype.injector;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.cdRef;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.cfRes;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.control;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.renderer;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.vcRef;
    /** @type {?} */
    ValidationDirective.prototype.parentRef;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.markRef;
    /** @type {?} */
    ValidationDirective.prototype.targetRef;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.containerRef;
    /**
     * @type {?}
     * @private
     */
    ValidationDirective.prototype.formGroupDirective;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmFsaWRhdGlvbi5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9Abmd4LXZhbGlkYXRlL2NvcmUvIiwic291cmNlcyI6WyJsaWIvZGlyZWN0aXZlcy92YWxpZGF0aW9uLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFFTCxpQkFBaUIsRUFDakIsd0JBQXdCLEVBQ3hCLFlBQVksRUFDWixTQUFTLEVBRVQsUUFBUSxFQUVSLFFBQVEsRUFDUixTQUFTLEVBQ1QsSUFBSSxFQUNKLFFBQVEsRUFDUixXQUFXLEVBQ1gsZ0JBQWdCLEdBQ2pCLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBYSxrQkFBa0IsRUFBRSxTQUFTLEVBQW9CLE1BQU0sZ0JBQWdCLENBQUM7QUFDNUYsT0FBTyxFQUFFLEtBQUssRUFBYyxZQUFZLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdkQsT0FBTyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3pELE9BQU8sRUFBRSwyQkFBMkIsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUczRCxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDbkQsT0FBTyxFQUFFLDRCQUE0QixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDaEYsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDeEUsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFDeEUsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFPMUUsTUFBTSxPQUFPLG1CQUFvQixTQUFRLDJCQUEyQjs7Ozs7Ozs7Ozs7Ozs7SUFnQmxFLFlBQ1MsUUFBa0IsRUFDakIsS0FBd0IsRUFDeEIsS0FBK0IsRUFDdkIsT0FBa0IsRUFDMUIsUUFBbUIsRUFDbkIsS0FBdUIsRUFDWixTQUFtQyxFQUN0QixPQUFpQyxFQUNsQyxTQUFvQyxFQUMvQyxZQUEwQyxFQUMxQyxrQkFBc0M7UUFFMUQsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBWlQsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNqQixVQUFLLEdBQUwsS0FBSyxDQUFtQjtRQUN4QixVQUFLLEdBQUwsS0FBSyxDQUEwQjtRQUN2QixZQUFPLEdBQVAsT0FBTyxDQUFXO1FBQzFCLGFBQVEsR0FBUixRQUFRLENBQVc7UUFDbkIsVUFBSyxHQUFMLEtBQUssQ0FBa0I7UUFDWixjQUFTLEdBQVQsU0FBUyxDQUEwQjtRQUN0QixZQUFPLEdBQVAsT0FBTyxDQUEwQjtRQUNsQyxjQUFTLEdBQVQsU0FBUyxDQUEyQjtRQUMvQyxpQkFBWSxHQUFaLFlBQVksQ0FBOEI7UUFDMUMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQXZCcEQsZ0JBQVcsR0FBRyxLQUFLLENBQUM7UUFVcEIsa0JBQWEsR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO0lBZ0IzQyxDQUFDOzs7O0lBeEJELElBQUksV0FBVztRQUNiLE9BQU8sS0FBSyxDQUNWLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsRUFDakQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUNoRCxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FDaEMsQ0FBQztJQUNKLENBQUM7Ozs7OztJQW9CTyxXQUFXLENBQUMsTUFBd0I7UUFDMUMsT0FBTyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sSUFBSSxFQUFFLENBQUMsQ0FBQyxHQUFHOzs7O1FBQUMsR0FBRyxDQUFDLEVBQUUsQ0FDekMsdUJBQXVCLENBQUMsR0FBRyxFQUFFLE1BQU0sQ0FBQyxHQUFHLENBQUMsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQ2hFLENBQUM7SUFDSixDQUFDOzs7OztJQUVPLGtCQUFrQjtRQUN4QixJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUNoRSxDQUFDOzs7Ozs7O0lBRU8sWUFBWSxDQUE0QixNQUEwQjs7Y0FDbEUsUUFBUSxHQUFHLElBQUksQ0FBQyxhQUFhOztjQUM3QixTQUFTLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTOztjQUM1RSxLQUFLLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSztRQUV0RCxJQUFJLENBQUMsUUFBUTtZQUNYLFFBQVEsWUFBWSxXQUFXO2dCQUM3QixDQUFDLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLFFBQVEsRUFBRSxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDO2dCQUN6RSxDQUFDLENBQUMsS0FBSyxDQUFDLGVBQWUsQ0FDbkIsSUFBSSxDQUFDLEtBQUssQ0FBQyx1QkFBdUIsQ0FBQyxRQUFRLENBQUMsRUFDNUMsS0FBSyxDQUFDLE1BQU0sRUFDWixJQUFJLENBQUMsUUFBUSxDQUNkLENBQUM7UUFFUixJQUFJLElBQUksQ0FBQyxRQUFRLFlBQVksWUFBWSxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUTtZQUNqRSxDQUFDLG1CQUFBLElBQUksQ0FBQyxRQUFRLEVBQXFCLENBQUMsQ0FBQyxRQUFRLENBQUMsZ0JBQWdCLEdBQUcsTUFBTSxDQUFDO0lBQzVFLENBQUM7Ozs7O0lBRU8sa0JBQWtCO1FBQ3hCLElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO0lBQ25FLENBQUM7Ozs7O0lBRU8sWUFBWTtRQUNsQixJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDakIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUN4QixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztTQUN0QjtJQUNILENBQUM7Ozs7O0lBRU8sY0FBYztRQUNwQixJQUFJLENBQUMsV0FBVztZQUNkLENBQUMsSUFBSSxDQUFDLE9BQU87Z0JBQ1gsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLGFBQWE7Z0JBQ2xDLENBQUMsQ0FBQyxJQUFJLENBQUMsY0FBYztvQkFDckIsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDO29CQUN2RCxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUM7SUFDMUMsQ0FBQzs7Ozs7O0lBRU8sY0FBYyxDQUFDLE1BQTBCO1FBQy9DLE9BQU8sTUFBTSxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLGdCQUFnQixJQUFJLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUM3RixDQUFDOzs7OztJQUVPLHFCQUFxQjs7WUFDdkIsTUFBYztRQUVsQixJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FDcEIsSUFBSSxDQUFDLFdBQVc7YUFDYixJQUFJLENBQ0gsTUFBTTs7O1FBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFDLEVBQ2xDLEdBQUc7Ozs7UUFBQyxJQUFJLENBQUMsRUFBRTtZQUNULElBQUksSUFBSSxJQUFJLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxTQUFTLEVBQUU7Z0JBQzdDLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxDQUFDO2dCQUNuQyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQzthQUN6QjtRQUNILENBQUMsRUFBQyxFQUNGLEdBQUc7OztRQUFDLEdBQUcsRUFBRSxDQUNQLElBQUksQ0FBQyxXQUFXLENBQ2QsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUNyQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLElBQUksQ0FBQyxtQkFBQSxFQUFFLEVBQWEsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEVBQ3BFLElBQUksQ0FBQyxPQUFPLENBQ2IsRUFDRixDQUNGO2FBQ0EsU0FBUzs7OztRQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ2xCLElBQUksTUFBTSxLQUFLLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDO2dCQUFFLE9BQU87WUFFOUMsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1lBRXBCLElBQUksSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsRUFBRTtnQkFDL0IsSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDMUIsSUFBSSxDQUFDLE1BQU07b0JBQUUsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7Z0JBQ3ZDLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2FBQ2pDO2lCQUFNO2dCQUNMLElBQUksQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO2dCQUMxQixNQUFNLEdBQUcsRUFBRSxDQUFDO2FBQ2I7WUFFRCxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQzVCLENBQUMsRUFBQyxDQUNMLENBQUM7SUFDSixDQUFDOzs7O0lBRUQsZUFBZTtRQUNiLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUN0QixJQUFJLENBQUMscUJBQXFCLEVBQUUsQ0FBQztJQUMvQixDQUFDOzs7O0lBRUQsV0FBVztRQUNULElBQUksQ0FBQyxhQUFhLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDbkMsQ0FBQzs7O1lBeElGLFNBQVMsU0FBQzs7Z0JBRVQsUUFBUSxFQUFFLGlDQUFpQztnQkFDM0MsUUFBUSxFQUFFLHFCQUFxQjthQUNoQzs7OztZQXpCQyxRQUFRO1lBTFIsaUJBQWlCO1lBQ2pCLHdCQUF3QjtZQWFjLFNBQVMsdUJBcUM1QyxJQUFJO1lBM0NQLFNBQVM7WUFJVCxnQkFBZ0I7WUFVVCx3QkFBd0IsdUJBZ0M1QixRQUFRO1lBL0JKLHdCQUF3Qix1QkFnQzVCLFFBQVEsWUFBSSxRQUFRO1lBL0JoQix5QkFBeUIsdUJBZ0M3QixRQUFRLFlBQUksUUFBUTtZQW5DaEIsNEJBQTRCLHVCQW9DaEMsUUFBUTtZQTNDTyxrQkFBa0IsdUJBNENqQyxRQUFROzs7Ozs7O0lBekJYLHVDQUFnRjs7Ozs7SUFDaEYsMENBQWlDOzs7OztJQUNqQywwQ0FBNEI7Ozs7O0lBVTVCLDRDQUEyQzs7SUFHekMsdUNBQXlCOzs7OztJQUN6QixvQ0FBZ0M7Ozs7O0lBQ2hDLG9DQUF1Qzs7Ozs7SUFDdkMsc0NBQWtDOzs7OztJQUNsQyx1Q0FBMkI7Ozs7O0lBQzNCLG9DQUErQjs7SUFDL0Isd0NBQXNEOzs7OztJQUN0RCxzQ0FBaUU7O0lBQ2pFLHdDQUFtRTs7Ozs7SUFDbkUsMkNBQThEOzs7OztJQUM5RCxpREFBMEQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBZnRlclZpZXdJbml0LFxuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICBDb21wb25lbnRSZWYsXG4gIERpcmVjdGl2ZSxcbiAgRW1iZWRkZWRWaWV3UmVmLFxuICBJbmplY3RvcixcbiAgT25EZXN0cm95LFxuICBPcHRpb25hbCxcbiAgUmVuZGVyZXIyLFxuICBTZWxmLFxuICBTa2lwU2VsZixcbiAgVGVtcGxhdGVSZWYsXG4gIFZpZXdDb250YWluZXJSZWYsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRm9ybUdyb3VwLCBGb3JtR3JvdXBEaXJlY3RpdmUsIE5nQ29udHJvbCwgVmFsaWRhdGlvbkVycm9ycyB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IG1lcmdlLCBPYnNlcnZhYmxlLCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGZpbHRlciwgbWFwLCBtYXBUbywgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQWJzdHJhY3RWYWxpZGF0aW9uRGlyZWN0aXZlIH0gZnJvbSAnLi4vYWJzdHJhY3RzJztcbmltcG9ydCB7IFZhbGlkYXRpb25FcnJvckNvbXBvbmVudCB9IGZyb20gJy4uL2NvbXBvbmVudHMnO1xuaW1wb3J0IHsgVmFsaWRhdGlvbiB9IGZyb20gJy4uL21vZGVscyc7XG5pbXBvcnQgeyBnZW5lcmF0ZVZhbGlkYXRpb25FcnJvciB9IGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB7IFZhbGlkYXRpb25Db250YWluZXJEaXJlY3RpdmUgfSBmcm9tICcuL3ZhbGlkYXRpb24tY29udGFpbmVyLmRpcmVjdGl2ZSc7XG5pbXBvcnQgeyBWYWxpZGF0aW9uR3JvdXBEaXJlY3RpdmUgfSBmcm9tICcuL3ZhbGlkYXRpb24tZ3JvdXAuZGlyZWN0aXZlJztcbmltcG9ydCB7IFZhbGlkYXRpb25TdHlsZURpcmVjdGl2ZSB9IGZyb20gJy4vdmFsaWRhdGlvbi1zdHlsZS5kaXJlY3RpdmUnO1xuaW1wb3J0IHsgVmFsaWRhdGlvblRhcmdldERpcmVjdGl2ZSB9IGZyb20gJy4vdmFsaWRhdGlvbi10YXJnZXQuZGlyZWN0aXZlJztcblxuQERpcmVjdGl2ZSh7XG4gIC8qIHRzbGludDpkaXNhYmxlLW5leHQtbGluZSAqL1xuICBzZWxlY3RvcjogJ1tmb3JtQ29udHJvbF0sW2Zvcm1Db250cm9sTmFtZV0nLFxuICBleHBvcnRBczogJ3ZhbGlkYXRpb25EaXJlY3RpdmUnLFxufSlcbmV4cG9ydCBjbGFzcyBWYWxpZGF0aW9uRGlyZWN0aXZlIGV4dGVuZHMgQWJzdHJhY3RWYWxpZGF0aW9uRGlyZWN0aXZlXG4gIGltcGxlbWVudHMgQWZ0ZXJWaWV3SW5pdCwgT25EZXN0cm95IHtcbiAgcHJpdmF0ZSBlcnJvclJlZjogQ29tcG9uZW50UmVmPFZhbGlkYXRpb25FcnJvckNvbXBvbmVudD4gfCBFbWJlZGRlZFZpZXdSZWY8YW55PjtcbiAgcHJpdmF0ZSBtYXJrRWxlbWVudDogSFRNTEVsZW1lbnQ7XG4gIHByaXZhdGUgaXNTdWJtaXR0ZWQgPSBmYWxzZTtcblxuICBnZXQgdmFsaWRhdGlvbiQoKTogT2JzZXJ2YWJsZTxGb3JtR3JvdXA+IHtcbiAgICByZXR1cm4gbWVyZ2UoXG4gICAgICB0aGlzLnBhcmVudC5nZXRTdHJlYW0oJ3N0YXR1cycpLnBpcGUobWFwVG8obnVsbCkpLFxuICAgICAgdGhpcy5wYXJlbnQuZ2V0U3RyZWFtKCd2YWx1ZScpLnBpcGUobWFwVG8obnVsbCkpLFxuICAgICAgdGhpcy5wYXJlbnQuZ2V0U3RyZWFtKCdzdWJtaXQnKSxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBzdWJzY3JpcHRpb25zID0gbmV3IFN1YnNjcmlwdGlvbigpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHB1YmxpYyBpbmplY3RvcjogSW5qZWN0b3IsXG4gICAgcHJpdmF0ZSBjZFJlZjogQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gICAgcHJpdmF0ZSBjZlJlczogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLFxuICAgIEBTZWxmKCkgcHJpdmF0ZSBjb250cm9sOiBOZ0NvbnRyb2wsXG4gICAgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyLFxuICAgIHByaXZhdGUgdmNSZWY6IFZpZXdDb250YWluZXJSZWYsXG4gICAgQFNraXBTZWxmKCkgcHVibGljIHBhcmVudFJlZjogVmFsaWRhdGlvbkdyb3VwRGlyZWN0aXZlLFxuICAgIEBPcHRpb25hbCgpIEBTa2lwU2VsZigpIHByaXZhdGUgbWFya1JlZjogVmFsaWRhdGlvblN0eWxlRGlyZWN0aXZlLFxuICAgIEBPcHRpb25hbCgpIEBTa2lwU2VsZigpIHB1YmxpYyB0YXJnZXRSZWY6IFZhbGlkYXRpb25UYXJnZXREaXJlY3RpdmUsXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBjb250YWluZXJSZWY6IFZhbGlkYXRpb25Db250YWluZXJEaXJlY3RpdmUsXG4gICAgQE9wdGlvbmFsKCkgcHJpdmF0ZSBmb3JtR3JvdXBEaXJlY3RpdmU6IEZvcm1Hcm91cERpcmVjdGl2ZSxcbiAgKSB7XG4gICAgc3VwZXIoaW5qZWN0b3IpO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZEVycm9ycyhlcnJvcnM6IFZhbGlkYXRpb25FcnJvcnMpOiBWYWxpZGF0aW9uLkVycm9yW10ge1xuICAgIHJldHVybiBPYmplY3Qua2V5cyhlcnJvcnMgfHwge30pLm1hcChrZXkgPT5cbiAgICAgIGdlbmVyYXRlVmFsaWRhdGlvbkVycm9yKGtleSwgZXJyb3JzW2tleV0sIHRoaXMuYmx1ZXByaW50c1trZXldKSxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBpbnNlcnRFcnJvckNsYXNzZXMoKSB7XG4gICAgdGhpcy5yZW5kZXJlci5hZGRDbGFzcyh0aGlzLm1hcmtFbGVtZW50LCB0aGlzLmludmFsaWRDbGFzc2VzKTtcbiAgfVxuXG4gIHByaXZhdGUgaW5zZXJ0RXJyb3JzKHRoaXM6IFZhbGlkYXRpb25EaXJlY3RpdmUsIGVycm9yczogVmFsaWRhdGlvbi5FcnJvcltdKTogdm9pZCB7XG4gICAgY29uc3QgdGVtcGxhdGUgPSB0aGlzLmVycm9yVGVtcGxhdGU7XG4gICAgY29uc3QgdGFyZ2V0UmVmID0gdGhpcy5jb250YWluZXJSZWYgPyB0aGlzLmNvbnRhaW5lclJlZi50YXJnZXRSZWYgOiB0aGlzLnRhcmdldFJlZjtcbiAgICBjb25zdCB2Y1JlZiA9IHRhcmdldFJlZiA/IHRhcmdldFJlZi52Y1JlZiA6IHRoaXMudmNSZWY7XG5cbiAgICB0aGlzLmVycm9yUmVmID1cbiAgICAgIHRlbXBsYXRlIGluc3RhbmNlb2YgVGVtcGxhdGVSZWZcbiAgICAgICAgPyB2Y1JlZi5jcmVhdGVFbWJlZGRlZFZpZXcodGVtcGxhdGUsIHsgJGltcGxpY2l0OiBlcnJvcnMgfSwgdmNSZWYubGVuZ3RoKVxuICAgICAgICA6IHZjUmVmLmNyZWF0ZUNvbXBvbmVudChcbiAgICAgICAgICAgIHRoaXMuY2ZSZXMucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkodGVtcGxhdGUpLFxuICAgICAgICAgICAgdmNSZWYubGVuZ3RoLFxuICAgICAgICAgICAgdGhpcy5pbmplY3RvcixcbiAgICAgICAgICApO1xuXG4gICAgaWYgKHRoaXMuZXJyb3JSZWYgaW5zdGFuY2VvZiBDb21wb25lbnRSZWYgJiYgdGhpcy5lcnJvclJlZi5pbnN0YW5jZSlcbiAgICAgICh0aGlzLmVycm9yUmVmIGFzIENvbXBvbmVudFJlZjxhbnk+KS5pbnN0YW5jZS52YWxpZGF0aW9uRXJyb3JzID0gZXJyb3JzO1xuICB9XG5cbiAgcHJpdmF0ZSByZW1vdmVFcnJvckNsYXNzZXMoKSB7XG4gICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDbGFzcyh0aGlzLm1hcmtFbGVtZW50LCB0aGlzLmludmFsaWRDbGFzc2VzKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlRXJyb3JzKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmVycm9yUmVmKSB7XG4gICAgICB0aGlzLmVycm9yUmVmLmRlc3Ryb3koKTtcbiAgICAgIHRoaXMuZXJyb3JSZWYgPSBudWxsO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2V0TWFya0VsZW1lbnQoKTogdm9pZCB7XG4gICAgdGhpcy5tYXJrRWxlbWVudCA9XG4gICAgICAodGhpcy5tYXJrUmVmXG4gICAgICAgID8gdGhpcy5tYXJrUmVmLmVsUmVmLm5hdGl2ZUVsZW1lbnRcbiAgICAgICAgOiB0aGlzLnRhcmdldFNlbGVjdG9yXG4gICAgICAgID8gdGhpcy5lbFJlZi5uYXRpdmVFbGVtZW50LmNsb3Nlc3QodGhpcy50YXJnZXRTZWxlY3RvcilcbiAgICAgICAgOiBudWxsKSB8fCB0aGlzLmVsUmVmLm5hdGl2ZUVsZW1lbnQ7XG4gIH1cblxuICBwcml2YXRlIHNob3VsZFZhbGlkYXRlKGVycm9yczogVmFsaWRhdGlvbi5FcnJvcltdKSB7XG4gICAgcmV0dXJuIGVycm9ycy5sZW5ndGggJiYgdGhpcy5jb250cm9sLmRpcnR5ICYmICghdGhpcy52YWxpZGF0ZU9uU3VibWl0IHx8IHRoaXMuaXNTdWJtaXR0ZWQpO1xuICB9XG5cbiAgcHJpdmF0ZSBzdWJzY3JpYmVUb1ZhbGlkYXRpb24oKTogdm9pZCB7XG4gICAgbGV0IGNhY2hlZDogc3RyaW5nO1xuXG4gICAgdGhpcy5zdWJzY3JpcHRpb25zLmFkZChcbiAgICAgIHRoaXMudmFsaWRhdGlvbiRcbiAgICAgICAgLnBpcGUoXG4gICAgICAgICAgZmlsdGVyKCgpID0+ICF0aGlzLnNraXBWYWxpZGF0aW9uKSxcbiAgICAgICAgICB0YXAoZm9ybSA9PiB7XG4gICAgICAgICAgICBpZiAoZm9ybSAmJiB0aGlzLmZvcm1Hcm91cERpcmVjdGl2ZS5zdWJtaXR0ZWQpIHtcbiAgICAgICAgICAgICAgdGhpcy5jb250cm9sLmNvbnRyb2wubWFya0FzRGlydHkoKTtcbiAgICAgICAgICAgICAgdGhpcy5pc1N1Ym1pdHRlZCA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSksXG4gICAgICAgICAgbWFwKCgpID0+XG4gICAgICAgICAgICB0aGlzLm1hcEVycm9yc0ZuKFxuICAgICAgICAgICAgICB0aGlzLmJ1aWxkRXJyb3JzKHRoaXMuY29udHJvbC5lcnJvcnMpLFxuICAgICAgICAgICAgICB0aGlzLmJ1aWxkRXJyb3JzKCh0aGlzLnBhcmVudFJlZi5ncm91cCB8fCAoe30gYXMgRm9ybUdyb3VwKSkuZXJyb3JzKSxcbiAgICAgICAgICAgICAgdGhpcy5jb250cm9sLFxuICAgICAgICAgICAgKSxcbiAgICAgICAgICApLFxuICAgICAgICApXG4gICAgICAgIC5zdWJzY3JpYmUoZXJyb3JzID0+IHtcbiAgICAgICAgICBpZiAoY2FjaGVkID09PSBKU09OLnN0cmluZ2lmeShlcnJvcnMpKSByZXR1cm47XG5cbiAgICAgICAgICB0aGlzLnJlbW92ZUVycm9ycygpO1xuXG4gICAgICAgICAgaWYgKHRoaXMuc2hvdWxkVmFsaWRhdGUoZXJyb3JzKSkge1xuICAgICAgICAgICAgdGhpcy5pbnNlcnRFcnJvcnMoZXJyb3JzKTtcbiAgICAgICAgICAgIGlmICghY2FjaGVkKSB0aGlzLmluc2VydEVycm9yQ2xhc3NlcygpO1xuICAgICAgICAgICAgY2FjaGVkID0gSlNPTi5zdHJpbmdpZnkoZXJyb3JzKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5yZW1vdmVFcnJvckNsYXNzZXMoKTtcbiAgICAgICAgICAgIGNhY2hlZCA9ICcnO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHRoaXMuY2RSZWYubWFya0ZvckNoZWNrKCk7XG4gICAgICAgIH0pLFxuICAgICk7XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKSB7XG4gICAgdGhpcy5zZXRNYXJrRWxlbWVudCgpO1xuICAgIHRoaXMuc3Vic2NyaWJlVG9WYWxpZGF0aW9uKCk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMudW5zdWJzY3JpYmUoKTtcbiAgfVxufVxuIl19